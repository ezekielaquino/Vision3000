!function(e,o){"object"==typeof exports&&"undefined"!=typeof module?module.exports=o():"function"==typeof define&&define.amd?define(o):e.vision3000=o()}(this,function(){var e=function(e){void 0===e&&(e={}),this.options={rootMargin:e.rootMargin||"0px 0px",threshold:e.threshold||[0,.1,.2,.3,.4,.5,.6,.7,.8,.9,1]},this.onIntersect=e.onIntersect,this.FPS=2,this.init()};return e.prototype.init=function(){var e=this;window.VISION3K={observer:new IntersectionObserver(function(o){e.intersect(o)},this.options),observe:this.observe,onIntersect:this.onIntersect,observables:[],inView:[],viewed:[],errors:[]},this.scrollIntent()},e.prototype.intersect=function(e){e.forEach(function(e){var o=e.target.observeId;window.VISION3K.inView=window.VISION3K.inView.filter(function(e){return e!==o}),e.isIntersecting&&window.VISION3K.inView.push(o)});var o=window.VISION3K.onIntersect||this.onIntersect;"function"==typeof o&&o(window.VISION3K.inView,window.VISION3K.viewed)},e.prototype.loadImages=function(){window.VISION3K.inView.forEach(function(e){if(!window.VISION3K.viewed.includes(e)){var o=window.VISION3K.observables[e],n=o.querySelector("img");window.VISION3K.viewed.push(e),"function"==typeof o.onLoadStart&&o.onLoadStart(o,n,window.VISION3K.viewed),function(e){var o=new Image;return new Promise(function(n,t){o.src=e,o.onload=n(o),o.onerror=t})}(n.dataset.src).then(function(e){e.classList=n.classList,e.decode().then(function(){n.replaceWith(e),"function"==typeof o.onLoad&&o.onLoad(o,n,window.VISION3K.viewed)})}).catch(function(e){console.error("Failed to load image "+n.dataset.src)})}})},e.prototype.scrollIntent=function(){var e=this;this.scrollProps={scrollSpeed:0,isHalted:!0,prevScrollSpeed:0,prevY:0};var o=function(){clearTimeout(e.timeout),e.timeout=setTimeout(function(){var n=Math.abs(window.scrollY-e.scrollProps.prevY),t=0===n;e.scrollProps={scrollSpeed:n,isHalted:t,prevY:window.scrollY,prevScrollSpeed:e.scrollProps.scrollSpeed},t&&e.loadImages(),o()},1e3/e.FPS)};o()},e.prototype.observe=function(e,o){window.VISION3K.observables.push(e),e.observeId=window.VISION3K.observables.length-1,e.onLoadStart=o.onLoadStart,e.onLoad=o.onLoad,window.VISION3K.observer.observe(e)},e});
